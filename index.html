<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Destiny 2 Build Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .item-card {
            background-color: #262A3A;
            border: 1px solid #4A5568;
            transition: all 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        .item-card.is-locked {
            opacity: 0.6;
            border-style: dashed;
        }
        .item-card.is-exotic {
            border-color: #FFD700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }
        .item-card.is-legendary {
            border-color: #be95ff;
            box-shadow: 0 0 15px rgba(190, 149, 255, 0.4);
        }
        .item-card.is-map {
            border-color: #ffffff;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
        }
        .item-card.is-jackpot {
            border-color: #f97316;
            box-shadow: 0 0 15px rgba(249, 115, 22, 0.5);
        }
        .item-name {
            font-weight: 700;
            letter-spacing: 0.025em;
        }
        .item-name.is-exotic {
            color: #FFD700;
        }
        .item-info-footer {
            font-size: 0.7rem;
            color: #A0AEC0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .icon-main {
            flex-grow: 1; 
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 0 0.5rem;
            min-height: 0; 
        }
        .icon-main svg {
            width: 60%;
            height: auto;
            max-height: 70px;
        }
        .weapon-name-text {
            white-space: normal;
            word-break: break-word;
        }
        .icon-footer svg {
            width: 16px;
            height: 16px;
        }
        .slot-title {
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #CBD5E0;
        }
        .btn-generate {
            transition: all 0.2s ease-in-out;
        }
        .btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0, 0.4);
        }
        .btn-generate:disabled {
            opacity: 0.5;
            cursor: wait;
        }

        .lock-toggle {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .lock-toggle:disabled {
            cursor: not-allowed;
            opacity: 0.3;
        }
        .lock-toggle svg {
            width: 20px;
            height: 20px;
            fill: white;
            transition: all 0.2s ease-in-out;
        }
        .lock-toggle.locked svg {
            fill: #3b82f6; 
            filter: drop-shadow(0 0 4px #3b82f6);
        }

        .slot-reel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            will-change: transform;
        }
        .reel-item {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border-bottom: 1px solid #1a1d26;
            padding: 0.5rem;
            height: 100%
        }
        /* Special Loadouts Toggle Styles */
        .special-toggle {
            cursor: pointer;
            user-select: none;
        }
        .special-toggle .toggle-dot {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        input:checked ~ .toggle-dot {
            transform: translateX(100%);
        }
        input:checked ~ .bg-gray-600 {
            background-color: #c026d3; /* Fuchsia-600 */
        }
    </style>
</head>
<body class="bg-[#111319] text-white min-h-screen flex flex-col items-center justify-center p-2 sm:p-4">

    <div class="w-full max-w-7xl mx-auto text-center flex flex-col h-full">
        <header class="py-4">
            <h1 class="text-3xl md:text-5xl font-black tracking-tighter">Destiny 2 Build Generator</h1>
            <p class="text-indigo-300 text-sm md:text-lg">Your complete random loadout, subclass, and map awaits.</p>
        </header>

        <div id="jackpot-display" class="hidden my-2 text-xl md:text-2xl font-bold text-orange-500 uppercase tracking-widest"></div>

        <main id="loadout-display" class="grid grid-cols-2 gap-2 sm:grid-cols-3 sm:gap-3 lg:grid-cols-5 lg:gap-4 my-auto">
            <!-- Subclass Slot -->
            <div class="p-2 sm:p-4 rounded-lg bg-[#1a1d26] flex flex-col">
                <h2 class="slot-title text-xs sm:text-sm mb-2 text-left">Subclass</h2>
                <div id="subclass-slot" class="item-card h-32 sm:h-40 lg:h-48 rounded-md flex-grow">
                     <span class="text-gray-500 m-auto text-xs sm:text-sm">Channeling the Light...</span>
                </div>
                 <div class="flex justify-center pt-2">
                    <button id="lock-subclass" data-slot="subclass" class="lock-toggle p-1 rounded-full hover:bg-gray-700 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 17a2 2 0 0 1-2-2v-4a2 2 0 1 1 4 0v4a2 2 0 0 1-2 2Zm6-9h-1V6a5 5 0 0 0-10 0v2H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2Zm-3 0H9V6a3 3 0 0 1 6 0v2Z"/></svg>
                    </button>
                </div>
            </div>
            <!-- Kinetic Slot -->
            <div class="p-2 sm:p-4 rounded-lg bg-[#1a1d26] flex flex-col">
                <h2 class="slot-title text-xs sm:text-sm mb-2 text-left">Kinetic</h2>
                <div id="kinetic-slot" class="item-card h-32 sm:h-40 lg:h-48 rounded-md flex-grow">
                    <span class="text-gray-500 m-auto text-xs sm:text-sm">Awaiting your fate...</span>
                </div>
                 <div class="flex justify-center pt-2">
                    <button id="lock-kinetic" data-slot="kinetic" class="lock-toggle p-1 rounded-full hover:bg-gray-700 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 17a2 2 0 0 1-2-2v-4a2 2 0 1 1 4 0v4a2 2 0 0 1-2 2Zm6-9h-1V6a5 5 0 0 0-10 0v2H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2Zm-3 0H9V6a3 3 0 0 1 6 0v2Z"/></svg>
                    </button>
                </div>
            </div>
            <!-- Energy Slot -->
            <div class="p-2 sm:p-4 rounded-lg bg-[#1a1d26] flex flex-col">
                <h2 class="slot-title text-xs sm:text-sm mb-2 text-left">Energy</h2>
                <div id="energy-slot" class="item-card h-32 sm:h-40 lg:h-48 rounded-md flex-grow">
                     <span class="text-gray-500 m-auto text-xs sm:text-sm">Awaiting your fate...</span>
                </div>
                 <div class="flex justify-center pt-2">
                    <button id="lock-energy" data-slot="energy" class="lock-toggle p-1 rounded-full hover:bg-gray-700 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 17a2 2 0 0 1-2-2v-4a2 2 0 1 1 4 0v4a2 2 0 0 1-2 2Zm6-9h-1V6a5 5 0 0 0-10 0v2H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2Zm-3 0H9V6a3 3 0 0 1 6 0v2Z"/></svg>
                    </button>
                </div>
            </div>
            <!-- Power Slot -->
            <div class="p-2 sm:p-4 rounded-lg bg-[#1a1d26] flex flex-col">
                <h2 class="slot-title text-xs sm:text-sm mb-2 text-left">Power</h2>
                <div id="power-slot" class="item-card h-32 sm:h-40 lg:h-48 rounded-md flex-grow">
                     <span class="text-gray-500 m-auto text-xs sm:text-sm">Awaiting your fate...</span>
                </div>
                 <div class="flex justify-center pt-2">
                    <button id="lock-power" data-slot="power" class="lock-toggle p-1 rounded-full hover:bg-gray-700 transition">
                       <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 17a2 2 0 0 1-2-2v-4a2 2 0 1 1 4 0v4a2 2 0 0 1-2 2Zm6-9h-1V6a5 5 0 0 0-10 0v2H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2Zm-3 0H9V6a3 3 0 0 1 6 0v2Z"/></svg>
                    </button>
                </div>
            </div>
            <!-- Map Slot -->
            <div class="p-2 sm:p-4 rounded-lg bg-[#1a1d26] flex flex-col col-span-2 sm:col-span-1">
                <h2 class="slot-title text-xs sm:text-sm mb-2 text-left">Map</h2>
                <div id="map-slot" class="item-card h-32 sm:h-40 lg:h-48 rounded-md flex-grow">
                     <span class="text-gray-500 m-auto text-xs sm:text-sm">Finding an arena...</span>
                </div>
                 <div class="flex justify-center pt-2">
                    <button id="lock-map" data-slot="map" class="lock-toggle p-1 rounded-full hover:bg-gray-700 transition">
                       <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 17a2 2 0 0 1-2-2v-4a2 2 0 1 1 4 0v4a2 2 0 0 1-2 2Zm6-9h-1V6a5 5 0 0 0-10 0v2H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2Zm-3 0H9V6a3 3 0 0 1 6 0v2Z"/></svg>
                    </button>
                </div>
            </div>
        </main>

        <footer class="py-4">
            <div class="flex flex-col items-center justify-center gap-4">
                 <button id="generate-build-btn" class="btn-generate bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-8 md:py-4 md:px-10 rounded-lg text-lg md:text-xl shadow-lg" style="box-shadow-color: #4f46e5;">
                    Generate Loadout
                </button>
                <label for="special-loadouts" class="special-toggle flex items-center cursor-pointer">
                    <div class="relative">
                        <input type="checkbox" id="special-loadouts" class="sr-only">
                        <div class="block bg-gray-600 w-14 h-8 rounded-full"></div>
                        <div class="toggle-dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"></div>
                    </div>
                    <div class="ml-3 text-fuchsia-400 font-semibold">Special Loadouts Only</div>
                </label>
            </div>
             <p id="error-message" class="text-red-400 mt-2 h-5 text-sm"></p>
        </footer>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM content loaded. Initializing script.");

            // --- DATA & ICONS (Destiny-Inspired) ---
            const icons = {
                ammo: { Primary: `<svg viewBox="0 0 100 100" fill="currentColor"><circle cx="50" cy="50" r="45" stroke-width="10" stroke="#fff" fill="none"/><circle cx="50" cy="50" r="25" fill="#fff"/></svg>`, Special: `<svg viewBox="0 0 100 100" fill="#a7ff83"><polygon points="50,5 95,95 5,95" stroke-width="5" stroke="#fff" fill="none"/><polygon points="50,25 80,80 20,80" fill="#fff"/></svg>`, Heavy: `<svg viewBox="0 0 100 100" fill="#8f6bff"><path d="M50 5 L95 35 L95 65 L50 95 L5 65 L5 35 Z" stroke-width="5" stroke="#fff" fill="none"/><path d="M50 25 L80 45 L80 55 L50 75 L20 55 L20 45 Z" fill="#fff"/></svg>` },
            };
            const subclasses = [{ name: "Solar", color: "#FF6347", icon: `<svg viewBox="0 0 24 24" stroke="#FF6347" fill="none" stroke-width="2"><path d="M12 2a4 4 0 00-4 4 4 4 0 004 4 4 4 0 004-4 4 4 0 00-4-4zM12 14a4 4 0 00-4 4 4 4 0 004 4 4 4 0 004-4 4 4 0 00-4-4zM2 12a4 4 0 004-4 4 4 0 00-4-4 4 4 0 00-4 4 4 4 0 004 4zM22 12a4 4 0 00-4-4 4 4 0 00-4 4 4 4 0 004 4 4 4 0 004-4z"/></svg>` }, { name: "Arc", color: "#00BFFF", icon: `<svg viewBox="0 0 24 24" stroke="#00BFFF" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>` }, { name: "Void", color: "#8A2BE2", icon: `<svg viewBox="0 0 24 24" stroke="#8A2BE2" fill="none" stroke-width="2"><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2z"/><path d="M12 7a5 5 0 00-5 5h10a5 5 0 00-5-5z"/></svg>` }, { name: "Stasis", color: "#4682B4", icon: `<svg viewBox="0 0 24 24" stroke="#4682B4" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l4 4-4 4-4-4 4-4zm0 18l4-4-4-4-4 4 4 4zm8-8l-4 4-4-4 4-4 4 4zM4 12l4 4-4 4-4-4 4-4z"/></svg>` }, { name: "Strand", color: "#32CD32", icon: `<svg viewBox="0 0 24 24" stroke="#32CD32" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 4l9 16 9-16M3 20h18M12 4v16"/></svg>` }, { name: "Prismatic", color: "#ec4899", icon: `<svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" /></svg>`},];
            const kineticElements = ['Kinetic', 'Stasis', 'Strand'];
            const lightElements = ['Arc', 'Solar', 'Void'];
            const pvpMaps = ["Javelin-4", "The Burnout", "Endless Vale", "Midtown", "Eternity", "Wormhaven", "The Anomaly", "Bannerfall", "Convergence", "Fragment", "Distant Shore", "Altar of Flame", "Pacifica", "Radiant Cliffs", "Disjunction", "Cathedral of Dusk", "Meltdown", "Rusted Lands", "Vostok", "Twilight Gap", "Widow's Court", "The Dead Cliffs", "Eventide Labs", "Cirrus Plaza", "Multiplex"];
            
            const jackpotSources = {
                 newLights: { name: "New Lights", weaponText: "Blue Rarity Only", cooldown: 0 },
                 raid: { name: 'Raid Night', weaponText: 'Raid Weapon', cooldown: 0 },
                 dungeon: { name: 'Spelunker', weaponText: 'Dungeon Weapon', cooldown: 0 },
                 vanguard: { name: 'The Vanguard\'s Armory', weaponText: 'Vanguard Weapon', cooldown: 0 },
                 crucible: { name: 'The Crucible\'s Finest', weaponText: 'Crucible Weapon', cooldown: 0 },
                 gambit: { name: 'The Drifter\'s Gambit', weaponText: 'Gambit Weapon', cooldown: 0 },
                 texMechanica: { name: "High Noon", weaponText: "Tex Mechanica Weapon", cooldown: 0 },
                 pointBlank: { name: "Point Blank", weaponText: "Sidearm, Shotgun, or Sword", cooldown: 0 },
                 threeStringSymphony: { name: "Three-String Symphony", weaponText: "Bow Only", cooldown: 0},
                 lionsPride: { name: "The Lion's Pride", weaponText: "Grenade Launcher Only", cooldown: 0},
                 blackArmory: { name: "Black Armory's Legacy", weaponText: "Black Armory Weapon", cooldown: 0 },
                 foundryClash: { name: "Foundry Clash", weaponText: { kinetic: "HAKKE Weapon", energy: "SUROS Weapon", power: "Any Power Weapon" }, cooldown: 0 },
                 greenWithEnvy: { name: "Green with Envy", weaponText: "Green Rarity Only", cooldown: 0},
                 queensGuard: { name: "The Queen's Guard", weaponText: "Last Wish or Dreaming City Weapon", cooldown: 0},
                 eighthSeraph: { name: "The Eighth Seraph", weaponText: "IKELOS or Seventh Seraph Weapon", cooldown: 0},
                 hiveGodSlayer: { name: "Hive God Slayer", weaponText: "Crota or King's Fall weapon", cooldown: 0}
            };
           
            const weaponPools = {
                kinetic: [], energy: [], power: []
            };

            const genericKinetic = [ { name: "Auto Rifle", type: "Legendary", ammo: "Primary", category: "Auto Rifle", isGeneric: true }, { name: "Hand Cannon", type: "Legendary", ammo: "Primary", category: "Hand Cannon", isGeneric: true }, { name: "Pulse Rifle", type: "Legendary", ammo: "Primary", category: "Pulse Rifle", isGeneric: true }, { name: "Scout Rifle", type: "Legendary", ammo: "Primary", category: "Scout Rifle", isGeneric: true }, { name: "SMG", type: "Legendary", ammo: "Primary", category: "SMG", isGeneric: true }, { name: "Sidearm", type: "Legendary", ammo: "Primary", category: "Sidearm", isGeneric: true }, { name: "Bow", type: "Legendary", ammo: "Primary", category: "Bow", isGeneric: true }, { name: "Shotgun", type: "Legendary", ammo: "Special", category: "Shotgun", isGeneric: true }, { name: "Sniper Rifle", type: "Legendary", ammo: "Special", category: "Sniper Rifle", isGeneric: true }, { name: "Grenade Launcher", type: "Legendary", ammo: "Special", category: "Grenade Launcher", isGeneric: true }, { name: "Fusion Rifle", type: "Legendary", ammo: "Special", category: "Fusion Rifle", isGeneric: true, noElement: true }];
            const genericEnergy = [ { name: "Auto Rifle", type: "Legendary", ammo: "Primary", category: "Auto Rifle", isGeneric: true }, { name: "Hand Cannon", type: "Legendary", ammo: "Primary", category: "Hand Cannon", isGeneric: true }, { name: "Pulse Rifle", type: "Legendary", ammo: "Primary", category: "Pulse Rifle", isGeneric: true }, { name: "Scout Rifle", type: "Legendary", ammo: "Primary", category: "Scout Rifle", isGeneric: true }, { name: "SMG", type: "Legendary", ammo: "Primary", category: "SMG", isGeneric: true }, { name: "Sidearm", type: "Legendary", ammo: "Primary", category: "Sidearm", isGeneric: true }, { name: "Bow", type: "Legendary", ammo: "Primary", category: "Bow", isGeneric: true }, { name: "Trace Rifle", type: "Legendary", ammo: "Primary", category: "Trace Rifle", isGeneric: true }, { name: "Shotgun", type: "Legendary", ammo: "Special", category: "Shotgun", isGeneric: true }, { name: "Sniper Rifle", type: "Legendary", ammo: "Special", category: "Sniper Rifle", isGeneric: true }, { name: "Fusion Rifle", type: "Legendary", ammo: "Special", category: "Fusion Rifle", isGeneric: true }, { name: "Grenade Launcher", type: "Legendary", ammo: "Special", category: "Grenade Launcher", isGeneric: true }, { name: "Glaive", type: "Legendary", ammo: "Special", category: "Glaive", isGeneric: true } ];
            const genericPower = [ { name: "Rocket Launcher", type: "Legendary", ammo: "Heavy", category: "Rocket Launcher", isGeneric: true }, { name: "Grenade Launcher", type: "Legendary", ammo: "Heavy", category: "Grenade Launcher", isGeneric: true }, { name: "Machine Gun", type: "Legendary", ammo: "Heavy", category: "Machine Gun", isGeneric: true }, { name: "Sword", type: "Legendary", ammo: "Heavy", category: "Sword", isGeneric: true }, { name: "Linear Fusion Rifle", type: "Legendary", ammo: "Heavy", category: "Linear Fusion Rifle", isGeneric: true } ];

            const exoticWeapons = {
                kinetic: [ { name: "Wish-Ender", type: "Exotic", ammo: "Primary", category: "Bow" }, { name: "Malfeasance", type: "Exotic", ammo: "Primary", category: "Hand Cannon" }, { name: "The Last Word", type: "Exotic", ammo: "Primary", category: "Hand Cannon" }, { name: "Khvostov 7G-0X", type: "Exotic", ammo: "Primary", category: "Auto Rifle" }, { name: "Monte Carlo", type: "Exotic", ammo: "Primary", category: "Auto Rifle" }, { name: "Witherhoard", type: "Exotic", ammo: "Special", category: "Grenade Launcher" }, { name: "Izanagi's Burden", type: "Exotic", ammo: "Special", category: "Sniper Rifle" }, { name: "Arbalest", type: "Exotic", ammo: "Special", category: "Linear Fusion Rifle" }, { name: "Ace of Spades", type: "Exotic", ammo: "Primary", category: "Hand Cannon" }, { name: "Thorn", type: "Exotic", ammo: "Primary", category: "Hand Cannon" }, { name: "Hawkmoon", type: "Exotic", ammo: "Primary", category: "Hand Cannon" }, { name: "Outbreak Perfected", type: "Exotic", ammo: "Primary", category: "Pulse Rifle" }, { name: "The Jade Rabbit", type: "Exotic", ammo: "Primary", category: "Scout Rifle" }, { name: "MIDA Multi-Tool", type: "Exotic", ammo: "Primary", category: "Scout Rifle" }, { name: "No Time to Explain", type: "Exotic", ammo: "Primary", category: "Pulse Rifle" }, { name: "Sturm", type: "Exotic", ammo: "Primary", category: "Hand Cannon" }, { name: "Bad Juju", type: "Exotic", ammo: "Primary", category: "Pulse Rifle" }, { name: "Rat King", type: "Exotic", ammo: "Primary", category: "Sidearm" }, { name: "Sweet Business", type: "Exotic", ammo: "Primary", category: "Auto Rifle" }, { name: "Revision Zero", type: "Exotic", ammo: "Primary", category: "Pulse Rifle" }, { name: "Cryosthesia 77K", type: "Exotic", ammo: "Primary", category: "Sidearm" }, { name: "Forerunner", type: "Exotic", ammo: "Special", category: "Sidearm" }, { name: "Euphony", type: "Exotic", ammo: "Special", category: "Linear Fusion Rifle" }, { name: "Crimson", type: "Exotic", ammo: "Primary", category: "Hand Cannon"}, { name: "Osteo Striga", type: "Exotic", ammo: "Primary", category: "SMG"}, { name: "Cerberus+1", type: "Exotic", ammo: "Primary", category: "Auto Rifle"}, { name: "Lumina", type: "Exotic", ammo: "Primary", category: "Hand Cannon" }, { name: "Verglas Curve", type: "Exotic", ammo: "Primary", category: "Bow" }, { name: "Final Warning", type: "Exotic", ammo: "Primary", category: "Sidearm" }, { name: "The Chaperone", type: "Exotic", ammo: "Special", category: "Shotgun" }, { name: "Huckleberry", type: "Exotic", ammo: "Primary", category: "SMG" }, { name: "Dead Man's Tale", type: "Exotic", ammo: "Primary", category: "Scout Rifle" }, { name: "Wish-Keeper", type: "Exotic", ammo: "Primary", category: "Bow" }, { name: "Wicked Implement", type: "Exotic", ammo: "Primary", category: "Scout Rifle" }, { name: "Touch of Malice", type: "Exotic", ammo: "Primary", category: "Scout Rifle" }, { name: "Necrochasm", type: "Exotic", ammo: "Primary", category: "Auto Rifle" }, { name: "Conditional Finality", type: "Exotic", ammo: "Special", category: "Shotgun" }, { name: "Vigilance Wing", type: "Exotic", ammo: "Primary", category: "Pulse Rifle" }, { name: "Quicksilver Storm", type: "Exotic", ammo: "Primary", category: "Auto Rifle" }, { name: "No Land Beyond", type: "Exotic", ammo: "Special", category: "Sniper Rifle" }],
                energy: [ { name: "Sunshot", type: "Exotic", ammo: "Primary", category: "Hand Cannon" }, { name: "Trinity Ghoul", type: "Exotic", ammo: "Primary", category: "Bow" }, { name: "Riskrunner", type: "Exotic", ammo: "Primary", category: "SMG" }, { name: "Graviton Lance", type: "Exotic", ammo: "Primary", category: "Pulse Rifle" }, { name: "Jötunn", type: "Exotic", ammo: "Special", category: "Fusion Rifle" }, { name: "Telesto", type: "Exotic", ammo: "Special", category: "Fusion Rifle" }, { name: "Merciless", type: "Exotic", ammo: "Special", category: "Fusion Rifle" }, { name: "Cloudstrike", type: "Exotic", ammo: "Special", category: "Sniper Rifle" }, { name: "Tessellation", type: "Exotic", ammo: "Special", category: "Fusion Rifle" }, { name: "Still Hunt", type: "Exotic", ammo: "Special", category: "Sniper Rifle" }, { name: "Ager's Scepter", type: "Exotic", ammo: "Special", category: "Trace Rifle" }, { name: "Divinity", type: "Exotic", ammo: "Special", category: "Trace Rifle" }, { name: "Vex Mythoclast", type: "Exotic", ammo: "Primary", category: "Fusion Rifle" }, { name: "Le Monarque", type: "Exotic", ammo: "Primary", category: "Bow" }, { name: "Symmetry", type: "Exotic", ammo: "Primary", category: "Scout Rifle"}, { name: "Tommy's Matchbook", type: "Exotic", ammo: "Primary", category: "Auto Rifle"}, { name: "Devil's Ruin", type: "Exotic", ammo: "Primary", category: "Sidearm"}, { name: "Ticuu's Divination", type: "Exotic", ammo: "Primary", category: "Bow"}, { name: "The Manticore", type: "Exotic", ammo: "Primary", category: "SMG"}, { name: "Trespasser", type: "Exotic", ammo: "Primary", category: "Sidearm"}, { name: "Ex Diris", type: "Exotic", ammo: "Special", category: "Grenade Launcher"}, { name: "Centrifuse", type: "Exotic", ammo: "Primary", category: "Auto Rifle"}, { name: "Tarrabah", type: "Exotic", ammo: "Primary", category: "SMG"}, { name: "Hard Light", type: "Exotic", ammo: "Primary", category: "Auto Rifle"}, { name: "Borealis", type: "Exotic", ammo: "Special", category: "Sniper Rifle"}, { name: "Skyburner's Oath", type: "Exotic", ammo: "Primary", category: "Scout Rifle"}, { name: "Fourth Horseman", type: "Exotic", ammo: "Special", category: "Shotgun"}, { name: "Lord of Wolves", type: "Exotic", ammo: "Special", category: "Shotgun"}, { name: "Eriana's Vow", type: "Exotic", ammo: "Special", category: "Hand Cannon" }, { name: "Dead Messenger", type: "Exotic", ammo: "Special", category: "Grenade Launcher"}, { name: "Fighting Lion", type: "Exotic", ammo: "Primary", category: "Grenade Launcher"}, { name: "Ruinous Effigy", type: "Exotic", ammo: "Primary", category: "Trace Rifle"}, { name: "Delicate Tomb", type: "Exotic", ammo: "Special", category: "Fusion Rifle"}, { name: "Wavesplitter", type: "Exotic", ammo: "Primary", category: "Trace Rifle"}, { name: "Prometheus Lens", type: "Exotic", ammo: "Primary", category: "Trace Rifle"}, { name: "Coldheart", type: "Exotic", ammo: "Primary", category: "Trace Rifle"}, { name: "Buried Bloodline", type: "Exotic", ammo: "Special", category: "Sidearm"}, { name: "The Navigator", type: "Exotic", ammo: "Special", category: "Trace Rifle"}, { name: "Hierarchy of Needs", type: "Exotic", ammo: "Primary", category: "Bow"}, { name: "Collective Obligation", type: "Exotic", ammo: "Primary", category: "Pulse Rifle"}, { name: "Polaris Lance", type: "Exotic", ammo: "Primary", category: "Scout Rifle"}, { name: "Duality", type: "Exotic", ammo: "Special", category: "Shotgun" }, { name: "Red Death Reformed", type: "Exotic", ammo: "Primary", category: "Pulse Rifle" } ],
                power: [ { name: "Gjallarhorn", type: "Exotic", ammo: "Heavy", category: "Rocket Launcher" }, { name: "The Lament", type: "Exotic", ammo: "Heavy", category: "Sword" }, { name: "Thunderlord", type: "Exotic", ammo: "Heavy", category: "Machine Gun" }, { name: "Leviathan's Breath", type: "Exotic", ammo: "Heavy", category: "Bow" }, { name: "Sleeper Simulant", type: "Exotic", ammo: "Heavy", category: "Linear Fusion Rifle" }, { name: "Tractor Cannon", type: "Exotic", ammo: "Heavy", category: "Shotgun" }, { name: "Dragon's Breath", type: "Exotic", ammo: "Heavy", category: "Rocket Launcher" }, { name: "Xenophage", type: "Exotic", ammo: "Heavy", category: "Machine Gun"}, { name: "The Prospector", type: "Exotic", ammo: "Heavy", category: "Grenade Launcher"}, { name: "Two-Tailed Fox", type: "Exotic", ammo: "Heavy", category: "Rocket Launcher"}, { name: "Black Talon", type: "Exotic", ammo: "Heavy", category: "Sword"}, { name: "Deathbringer", type: "Exotic", ammo: "Heavy", category: "Rocket Launcher"}, { name: "The Wardcliff Coil", type: "Exotic", ammo: "Heavy", category: "Rocket Launcher"}, { name: "Eyes of Tomorrow", type: "Exotic", ammo: "Heavy", category: "Rocket Launcher"}, { name: "The Colony", type: "Exotic", ammo: "Heavy", category: "Grenade Launcher"}, { name: "Microcosm", type: "Exotic", ammo: "Heavy", category: "Trace Rifle" }, { name: "One Thousand Voices", type: "Exotic", ammo: "Heavy", category: "Fusion Rifle" }, { name: "Whisper of the Worm", type: "Exotic", ammo: "Heavy", category: "Sniper Rifle" } ]
            };
            
            weaponPools.kinetic = [...exoticWeapons.kinetic, ...genericKinetic];
            weaponPools.energy = [...exoticWeapons.energy, ...genericEnergy];
            weaponPools.power = [...exoticWeapons.power, ...genericPower];
    
            let currentBuild = null;
            let lockStates = {
                subclass: false,
                kinetic: false,
                energy: false,
                power: false,
                map: false,
            };
    
            const dom = { 
                subclass: document.getElementById('subclass-slot'), 
                kinetic: document.getElementById('kinetic-slot'), 
                energy: document.getElementById('energy-slot'), 
                power: document.getElementById('power-slot'), 
                map: document.getElementById('map-slot'), 
                errorMessage: document.getElementById('error-message'),
                lockToggles: document.querySelectorAll('.lock-toggle'),
                jackpotDisplay: document.getElementById('jackpot-display'),
                generateBtn: document.getElementById('generate-build-btn'),
                specialLoadoutsToggle: document.getElementById('special-loadouts')
            };

            console.log("DOM elements targeted. Found generate button:", dom.generateBtn);
            console.log("Found special loadouts toggle:", dom.specialLoadoutsToggle);
            
            // --- INITIAL STATE ---
            dom.generateBtn.disabled = true;
            dom.lockToggles.forEach(toggle => toggle.disabled = true);
            
            document.fonts.ready.then(() => {
                dom.generateBtn.disabled = false;
            });
            
            // --- EVENT LISTENERS ---
            dom.generateBtn.addEventListener('click', () => {
                const forceJackpot = dom.specialLoadoutsToggle.checked;
                handleGeneration(forceJackpot);
            });
    
            dom.lockToggles.forEach(toggle => {
                toggle.addEventListener('click', () => {
                    if(!currentBuild) return; 
                    const slot = toggle.dataset.slot;
                    lockStates[slot] = !lockStates[slot];
                    toggle.classList.toggle('locked', lockStates[slot]);
                    dom[slot].classList.toggle('is-locked', lockStates[slot]);
                });
            });

    
            // --- FUNCTIONS ---
            const getRandomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];
    
            const createWeaponCardContent = (weapon, jackpotTheme = null) => {
                const isExotic = weapon.type === 'Exotic';
                let title = weapon.category;
                let weaponName = weapon.name;

                if (jackpotTheme) {
                    title = jackpotTheme.name;
                    // If the weapon is a generic placeholder, use the jackpot's specific text.
                    if (weapon.isGeneric && jackpotTheme.weaponText) {
                        if (typeof jackpotTheme.weaponText === 'object') {
                            if (weapon.slot === 'kinetic') weaponName = jackpotTheme.weaponText.kinetic;
                            else if (weapon.slot === 'energy') weaponName = jackpotTheme.weaponText.energy;
                            else if (weapon.slot === 'power') weaponName = jackpotTheme.weaponText.power;
                        } else {
                            weaponName = jackpotTheme.weaponText;
                        }
                    }
                    // Otherwise, `weaponName` remains the weapon's actual name (e.g., "One Thousand Voices").
                }

                return `<div class="reel-item" style="height: 100%;">
                            <div class="item-header">
                                <h3 class="item-name !text-xs sm:!text-sm !font-normal normal-case text-gray-400">${title}</h3>
                            </div>
                            <div class="icon-main">
                                <span class="weapon-name-text text-lg sm:text-xl md:text-2xl font-bold leading-tight ${isExotic ? 'text-yellow-300' : 'text-white'}">${weaponName}</span>
                            </div>
                            <div class="item-info-footer">
                                <div class="icon-footer" style="color:${isExotic ? '#FFD700' : 'white'}">${icons.ammo[weapon.ammo] || ''}</div>
                                <span>${weapon.ammo || ''}</span>
                            </div>
                        </div>`;
            };
            const createSubclassCardContent = (subclass) => `<div class="reel-item" style="height: 100%;"><h3 class="item-name !text-base sm:!text-lg" style="color:${subclass.color}">${subclass.name}</h3><div class="icon-main">${subclass.icon}</div><div class="item-info-footer"><span>Element</span></div></div>`;
            const createMapCardContent = (mapName) => `
                <div class="reel-item" style="height: 100%;">
                    <h3 class="item-name !text-xs sm:!text-sm !font-normal normal-case text-gray-400">Crucible Map</h3>
                    <div class="icon-main">
                        <span class="text-xl md:text-2xl font-bold text-white">${mapName}</span>
                    </div>
                    <div class="item-info-footer">
                        <span>Arena</span>
                    </div>
                </div>`;
    
            const animateSlot = (slotElement, itemPool, finalItem, duration, createContentFunc, jackpotTheme = null) => {
                return new Promise(resolve => {
                    if (!slotElement) {
                        console.error('animateSlot was called with an invalid slotElement.');
                        resolve();
                        return;
                    }
                    const reel = document.createElement('div');
                    reel.className = 'slot-reel';
                    
                    const reelItemCount = 30;
                    let reelHTML = '';
                    const itemHeight = slotElement.clientHeight;
    
                    for (let i = 0; i < reelItemCount; i++) {
                        const item = (i === reelItemCount - 1) ? finalItem : getRandomItem(itemPool);
                        reelHTML += `<div class="reel-item" style="height: ${itemHeight}px">${createContentFunc(item, jackpotTheme)}</div>`;
                    }
                    reel.innerHTML = reelHTML;
                    
                    slotElement.innerHTML = '';
                    slotElement.appendChild(reel);
                    
                    const finalPosition = -((reelItemCount - 1) * itemHeight);
    
                    requestAnimationFrame(() => {
                        reel.style.transition = `transform ${duration / 1000}s cubic-bezier(0.25, 1, 0.5, 1)`;
                        reel.style.transform = `translateY(${finalPosition}px)`;
                    });
                    
                    reel.addEventListener('transitionend', () => {
                        slotElement.innerHTML = createContentFunc(finalItem, jackpotTheme);
                        resolve();
                    }, { once: true });
                });
            };
            
            const generateNewValidBuild = (lockedItems) => {
                let attempts = 0;
                while(attempts < 200) { 
                    attempts++;
    
                    let { kineticWeapon, energyWeapon, powerWeapon } = lockedItems;
                    const hasLockedExotic = !!(kineticWeapon?.type === 'Exotic' || energyWeapon?.type === 'Exotic' || powerWeapon?.type === 'Exotic');
                    const rollForExotic = !hasLockedExotic && Math.random() < 0.7;
                    
                    const unlockedSlots = [];
                    if (!kineticWeapon) unlockedSlots.push('kinetic');
                    if (!energyWeapon) unlockedSlots.push('energy');
                    if (!powerWeapon) unlockedSlots.push('power');
                    
                    const exoticSlot = rollForExotic && unlockedSlots.length > 0 ? getRandomItem(unlockedSlots) : null;
                    
                    if (!powerWeapon) {
                        const powerPool = weaponPools.power.filter(w => exoticSlot === 'power' ? w.type === 'Exotic' : w.type === 'Legendary');
                        if (!powerPool.length) continue;
                        powerWeapon = getRandomItem(powerPool);
                    }
                    
                     if (!kineticWeapon) {
                        const kineticPool = weaponPools.kinetic.filter(w => exoticSlot === 'kinetic' ? w.type === 'Exotic' : w.type === 'Legendary');
                        if (!kineticPool.length) continue;
                        kineticWeapon = getRandomItem(kineticPool);
                    }
                    if (!energyWeapon) {
                        let energyPool = weaponPools.energy.filter(w => exoticSlot === 'energy' ? w.type === 'Exotic' : w.type === 'Legendary');
                        if (kineticWeapon.ammo === 'Special') {
                                energyPool = energyPool.filter(w => w.ammo === 'Primary');
                        }
                        if (!energyPool.length) continue;
                        energyWeapon = getRandomItem(energyPool);
                    }
                    
    
                    if(kineticWeapon && energyWeapon && powerWeapon) {
                        if (kineticWeapon.ammo === 'Special' && energyWeapon.ammo === 'Special') continue;
                        
                        if (kineticWeapon.isGeneric && !lockedItems.kineticWeapon && Math.random() < 0.5 && !kineticWeapon.noElement) {
                            kineticWeapon = {...kineticWeapon, name: `${getRandomItem(kineticElements)} ${kineticWeapon.name}`};
                        }
                         if (energyWeapon.isGeneric && !lockedItems.energyWeapon && Math.random() < 0.5) {
                            energyWeapon = {...energyWeapon, name: `${getRandomItem(lightElements)} ${energyWeapon.name}`};
                        }
                       
                        return {
                            subclass: lockedItems.subclass || getRandomItem(subclasses),
                            kineticWeapon,
                            energyWeapon,
                            powerWeapon,
                            map: lockedItems.map || getRandomItem(pvpMaps)
                        };
                    }
                }
                return null; 
            }
            
            async function handleGeneration(isJackpotForced = false) {
                // Decrease all non-zero cooldowns by 1
                Object.keys(jackpotSources).forEach(key => {
                    if (jackpotSources[key].cooldown > 0) {
                        jackpotSources[key].cooldown--;
                    }
                });
                console.log("Current Cooldowns:", Object.fromEntries(Object.entries(jackpotSources).map(([k, v]) => [k, v.cooldown])));


                console.log("handleGeneration called. Forced jackpot:", isJackpotForced);
                const button = dom.generateBtn;
                button.disabled = true;
                const originalText = button.textContent;
                button.textContent = 'Generating...';
    
                dom.errorMessage.textContent = '';
                dom.jackpotDisplay.classList.add('hidden');
                
                Object.keys(lockStates).forEach(slot => { 
                     if (!lockStates[slot]) {
                        const el = dom[slot];
                         if(el) {
                            el.classList.remove('is-exotic', 'is-legendary', 'is-map', 'is-jackpot');
                            el.style.borderColor = '';
                            el.style.boxShadow = '';
                         }
                    }
                });
    
                const isAnySlotLocked = Object.values(lockStates).some(state => state);
                let isJackpotRoll = !isAnySlotLocked && (isJackpotForced || Math.random() < 0.15);
                let jackpotTheme = null;
                let loadout;
    
                if (isJackpotRoll) {
                    const availableJackpotKeys = Object.keys(jackpotSources).filter(key => jackpotSources[key].cooldown === 0);
                    
                    if (availableJackpotKeys.length === 0) {
                        console.log("All jackpots on cooldown. Skipping jackpot roll.");
                        isJackpotRoll = false; // Force a normal roll if no jackpots are available
                    } else {
                        const randomThemeKey = getRandomItem(availableJackpotKeys);
                        // IMPORTANT: Set cooldown on the original object immediately.
                        jackpotSources[randomThemeKey].cooldown = 5; 
                        // IMPORTANT: Create a COPY of the theme for this specific roll to prevent mutation.
                        jackpotTheme = { ...jackpotSources[randomThemeKey], key: randomThemeKey };
                        console.log(`Chose jackpot: ${randomThemeKey}. Cooldown set to 5.`);
                    
                        // Specific Jackpot Logic
                        if (randomThemeKey === 'threeStringSymphony') {
                            const levisBreath = exoticWeapons.power.find(w => w.name === "Leviathan's Breath");
                            loadout = {
                                kineticWeapon: { name: "Bow", type: "Legendary", ammo: "Primary", category: "Bow", isGeneric: true, slot: 'kinetic' },
                                energyWeapon: { name: "Bow", type: "Legendary", ammo: "Primary", category: "Bow", isGeneric: true, slot: 'energy' },
                                powerWeapon: { ...levisBreath, slot: 'power' },
                            };
                            jackpotTheme.weaponText = null; 
                        } else if (randomThemeKey === 'lionsPride') {
                            const fightingLion = exoticWeapons.energy.find(w => w.name === "Fighting Lion");
                            loadout = {
                                kineticWeapon: { name: "Grenade Launcher", type: "Legendary", ammo: "Special", category: "Grenade Launcher", isGeneric: true, slot: 'kinetic' },
                                energyWeapon: { ...fightingLion, slot: 'energy' },
                                powerWeapon: { name: "Grenade Launcher", type: "Legendary", ammo: "Heavy", category: "Grenade Launcher", isGeneric: true, slot: 'power' },
                            };
                            jackpotTheme.weaponText = null;
                        } else if (randomThemeKey === 'queensGuard') {
                            const oneKV = exoticWeapons.power.find(w => w.name === "One Thousand Voices");
                            loadout = {
                                kineticWeapon: { name: "Last Wish or Dreaming City Weapon", type: "Legendary", ammo: "Any", category: jackpotTheme.name, isGeneric: true, slot: 'kinetic' },
                                energyWeapon: { name: "Last Wish or Dreaming City Weapon", type: "Legendary", ammo: "Any", category: jackpotTheme.name, isGeneric: true, slot: 'energy' },
                                powerWeapon: { ...oneKV, slot: 'power' },
                            };
                        } else if (randomThemeKey === 'eighthSeraph') {
                            const sleeper = exoticWeapons.power.find(w => w.name === "Sleeper Simulant");
                            loadout = {
                                kineticWeapon: { name: "IKELOS or Seventh Seraph Weapon", type: "Legendary", ammo: "Any", category: jackpotTheme.name, isGeneric: true, slot: 'kinetic' },
                                energyWeapon: { name: "IKELOS or Seventh Seraph Weapon", type: "Legendary", ammo: "Any", category: jackpotTheme.name, isGeneric: true, slot: 'energy' },
                                powerWeapon: { ...sleeper, slot: 'power' },
                            };
                        } else if (randomThemeKey === 'hiveGodSlayer') {
                            const hiveExotics = ['Thorn', 'Osteo Striga', 'Touch of Malice', 'Necrochasm', 'Ex Diris', 'Whisper of the Worm'];
                            const chosenExoticName = getRandomItem(hiveExotics);
                            let chosenExotic = null;
                            let exoticSlotType = '';

                            if (exoticWeapons.kinetic.some(w => w.name === chosenExoticName)) {
                                chosenExotic = exoticWeapons.kinetic.find(w => w.name === chosenExoticName);
                                exoticSlotType = 'kinetic';
                            } else if (exoticWeapons.energy.some(w => w.name === chosenExoticName)) {
                                chosenExotic = exoticWeapons.energy.find(w => w.name === chosenExoticName);
                                exoticSlotType = 'energy';
                            } else {
                                chosenExotic = exoticWeapons.power.find(w => w.name === chosenExoticName);
                                exoticSlotType = 'power';
                            }
                            
                            const placeholderWeapon = { name: "Crota or King's Fall weapon", type: "Legendary", ammo: "Any", category: jackpotTheme.name, isGeneric: true };
                            loadout = {
                                kineticWeapon: exoticSlotType === 'kinetic' ? { ...chosenExotic, slot: 'kinetic' } : { ...placeholderWeapon, slot: 'kinetic' },
                                energyWeapon: exoticSlotType === 'energy' ? { ...chosenExotic, slot: 'energy' } : { ...placeholderWeapon, slot: 'energy' },
                                powerWeapon: exoticSlotType === 'power' ? { ...chosenExotic, slot: 'power' } : { ...placeholderWeapon, slot: 'power' },
                            };

                        } else if (typeof jackpotTheme.weaponText === 'object') {
                            loadout = {
                                kineticWeapon: { name: jackpotTheme.weaponText.kinetic, slot: 'kinetic', type: 'Legendary', ammo: 'Any', category: jackpotTheme.name, isGeneric: true },
                                energyWeapon: { name: jackpotTheme.weaponText.energy, slot: 'energy', type: 'Legendary', ammo: 'Any', category: jackpotTheme.name, isGeneric: true },
                                powerWeapon: { name: jackpotTheme.weaponText.power, slot: 'power', type: 'Legendary', ammo: 'Any', category: jackpotTheme.name, isGeneric: true },
                            };
                        } else {
                            loadout = {
                                kineticWeapon: { name: jackpotTheme.weaponText, type: 'Legendary', ammo: 'Any', category: jackpotTheme.name, isGeneric: true, slot: 'kinetic' },
                                energyWeapon: { name: jackpotTheme.weaponText, type: 'Legendary', ammo: 'Any', category: jackpotTheme.name, isGeneric: true, slot: 'energy' },
                                powerWeapon: { name: jackpotTheme.weaponText, type: 'Legendary', ammo: 'Any', category: jackpotTheme.name, isGeneric: true, slot: 'power' },
                            };
                        }
                        dom.jackpotDisplay.textContent = jackpotTheme.name;
                        dom.jackpotDisplay.classList.remove('hidden');
                    }
                }
                
                if (!isJackpotRoll) {
                     const lockedItems = {};
                    if (lockStates.subclass) lockedItems.subclass = currentBuild.subclass;
                    if (lockStates.kinetic) lockedItems.kineticWeapon = currentBuild.kineticWeapon;
                    if (lockStates.energy) lockedItems.energyWeapon = currentBuild.energyWeapon;
                    if (lockStates.power) lockedItems.powerWeapon = currentBuild.powerWeapon;
                    if (lockStates.map) lockedItems.map = currentBuild.map;
                    loadout = generateNewValidBuild(lockedItems);
                }
    
                if (!loadout) {
                     console.error("Failed to generate a valid loadout.");
                     dom.errorMessage.textContent = 'Could not generate a valid loadout. Please try again.';
                     button.disabled = false;
                     button.textContent = originalText;
                     return;
                }
                
                currentBuild = currentBuild || {};
                if (!lockStates.subclass) currentBuild.subclass = loadout.subclass || getRandomItem(subclasses);
                if (!lockStates.kinetic) currentBuild.kineticWeapon = loadout.kineticWeapon;
                if (!lockStates.energy) currentBuild.energyWeapon = loadout.energyWeapon;
                if (!lockStates.power) currentBuild.powerWeapon = loadout.powerWeapon;
                if (!lockStates.map) currentBuild.map = loadout.map || getRandomItem(pvpMaps);
    
                const { kineticWeapon, energyWeapon, powerWeapon, subclass, map } = currentBuild;
                
                const animations = [];
                const dummyPool = [kineticWeapon, energyWeapon, powerWeapon];
    
                if (!lockStates.subclass) animations.push(animateSlot(dom.subclass, subclasses, subclass, 1000, createSubclassCardContent, jackpotTheme));
                if (!lockStates.kinetic) animations.push(animateSlot(dom.kinetic, isJackpotRoll ? dummyPool : weaponPools.kinetic, kineticWeapon, 1500, createWeaponCardContent, jackpotTheme));
                if (!lockStates.energy) animations.push(animateSlot(dom.energy, isJackpotRoll ? dummyPool : weaponPools.energy, energyWeapon, 2000, createWeaponCardContent, jackpotTheme));
                if (!lockStates.power) animations.push(animateSlot(dom.power, isJackpotRoll ? dummyPool : weaponPools.power, powerWeapon, 2500, createWeaponCardContent, jackpotTheme));
                if (!lockStates.map) animations.push(animateSlot(dom.map, pvpMaps, map, 3000, createMapCardContent, jackpotTheme));
    
                await Promise.all(animations);
                
                if (isJackpotRoll) {
                    dom.kinetic.classList.add('is-jackpot');
                    dom.energy.classList.add('is-jackpot');
                    dom.power.classList.add('is-jackpot');
                }
                
                if (kineticWeapon.type === 'Exotic') { dom.kinetic.classList.add('is-exotic'); } else { dom.kinetic.classList.add('is-legendary'); }
                if (energyWeapon.type === 'Exotic') { dom.energy.classList.add('is-exotic'); } else { dom.energy.classList.add('is-legendary'); }
                if (powerWeapon.type === 'Exotic') { dom.power.classList.add('is-exotic'); } else { dom.power.classList.add('is-legendary'); }
                
                dom.map.classList.add('is-map');
                if (subclass && subclass.color) {
                    dom.subclass.style.borderColor = subclass.color;
                    dom.subclass.style.boxShadow = `0 0 15px ${subclass.color}66`;
                }

    
                button.disabled = false;
                dom.lockToggles.forEach(toggle => toggle.disabled = false); 
                button.textContent = originalText;
            }
        });
    </script>
</body>
</html>
